function [psicntrl,psib,r_cntrl_pnts,z_cntrl_pnts,status]= getCCSflux(t,p,e,Ip,IPF,IIC,psi_sens,B_sens,r_cntrl_gap_eq,z_cntrl_gap_eq)

% coder.extrinsic('system');
% coder.extrinsic('run');
% coder.extrinsic('num2str');
% coder.extrinsic('pdemesh');


%%%%Fill the fort.70

%% Dummy data
% Ip = 5.5; %%is already in MA
Ip = Ip*1e-6;
IPF = IPF*1e-6;
IIC = IIC*1e-6;
   psi_sens = psi_sens;
% IPF = [1 2 3 4 5 6 7 8 9 10]*1e3;
% IIC = [11 12]*1e3;
% B_sens = linspace(1e-1,5e-1,45); % 45 field sensors
% psi_sens = linspace(-0.5,2.5,34); % 34 flux loops


%%% Control points for isoflux
ncp = length(r_cntrl_gap_eq)-1;
% rcp = [0 1:10]; % 1st value must be zero?
% rcp=[0.00000000e+00, 4.00000000e+00, 3.60000000e+00, 2.10000000e+00 ,...
%     2.10000000e+00, 3.60000000e+00];
r_cntrl_gap_eq(1)=0;
rcp=r_cntrl_gap_eq';

% zcp = [0 11:20];
% zcp=[ 0.00000000e+00, 0.00000000e+00, 1.10000000e+00,...
%     1.60000000e+00,-1.60000000e+00,-1.10000000e+00];

z_cntrl_gap_eq(1)=0;
zcp=z_cntrl_gap_eq';

%%% Currents
% IPF=[-1.79500000e-03,-1.28500000e-02,-1.23900000e-02,...
%     -3.73900000e-03,-1.01300000e-02,-1.41700000e-02,...
%     1.36600000e-02, 1.02200000e-02, 3.63400000e-03,...
%     -1.87800000e-02];
% 
% IIC=[ 0.00000000e+00, 0.00000000e+00];
% 

%%% Field probes
% B_sens=[-2.93739000e-01, 1.64108000e-01, 1.31916100e+00, ...
%     1.87274400e+00, 2.08695600e+00, 2.16375900e+00, 2.09104000e+00,...
%     1.96193100e+00, 2.34451600e+00, 2.26190500e+00, 1.82612600e+00, ...
%     1.26108200e+00,-7.67500000e-02,-3.08937000e-01,-2.83100000e-03,...
%     2.02911000e-01, 3.29692000e-01, 3.53890000e-01, 3.11150000e-01,...
%     2.97641000e-01, 3.15344000e-01, 3.75148000e-01, 3.73400000e-01,...
%     3.05210000e-01,-6.57550000e-02,-4.77600000e-01,-4.74916000e-01,...
%     1.02603400e+00, 6.30836000e-01, 5.92683000e-01, 4.46055000e-01,...
%     6.33737000e-01, 6.58667000e-01, 5.40818000e-01];
% 

%%% Flux probes
% psi_sens=[5.76929000e-01, 6.72202000e-01, 6.65858000e-01, ...
%     6.35500000e-01, 6.52566000e-01, 6.74567000e-01, 5.16086000e-01, ...
%     1.81483000e-01,-3.24925000e-01,-3.84236000e-01,-9.20830000e-02,...
%     1.54298000e-01, 4.62897000e-01, 7.81376000e-01, 1.06759800e+00,...
%     1.12885400e+00, 1.05237800e+00, 7.74926000e-01, 4.94337000e-01,...
%     2.42900000e-01,-2.44260000e-02,-3.53074000e-01,-3.84375000e-01, ...
%     3.17130000e-02, 4.47325000e-01, 7.07756000e-01, 8.38931000e-01,...
%     7.53321000e-01, 6.39054000e-01, 5.45122000e-01, 5.94844000e-01,...
%     6.69196000e-01, 7.14051000e-01, 7.6384deg2rad+pi/23000e-01, 7.86789000e-01, ...
%     7.80176000e-01, 7.43075000e-01, 7.56568000e-01, 7.00523000e-01, ...
%     7.42489000e-01, 7.68867000e-01, 7.69857000e-01, 7.43815000e-01,...
%     7.00022000e-01, 6.19302000e-01];

%% Only if the time is bigger tahn some value
% if t > 0 && t< 0.5
if 1
    
matlab2namelist_smlnk2(t,Ip,IPF,IIC,B_sens,psi_sens,ncp,rcp,zcp);

%% Run ccs_sa
status=1;
status=system('./ccs_sa');

%% Extract control flux from fort.71
psib = 0;
psicntrl = zeros(20,1);
 r_cntrl_pnts=zeros(20,1);
 z_cntrl_pnts=zeros(20,1);


[psib,psicntrl,r_cntrl_pnts,z_cntrl_pnts]=getFluxfort71();


end



